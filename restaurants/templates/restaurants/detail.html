{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% block css %}
  <link rel="stylesheet" href="{% static 'restaurants/css/detail.css' %}">
{% endblock css %}

{% block content %}
  <!-- ìŒì‹ì  ì •ë³´ -->
  <div class="row r_info">
    <!-- ìŒì‹ì  ì •ë³´ í—¤ë” -->
    <div class="r_header">
      <h2>{{ restaurant.restaurant_name }}
        <span class="grade">{{ grade }}</span>
      </h2>
      <div class="detailed_info">
        <!-- ì¡°íšŒìˆ˜ -->
        <div class="people_views">
          <img class="m-1" src="https://cdn-icons-png.flaticon.com/512/159/159604.png" alt="ì¡°íšŒìˆ˜ ì•„ì´ì½˜">
          <span>{{ restaurant.hits }}</span>
          <div class="d-none">{{ restaurant.click }}</div>
        </div>
        <p class="division">â”ƒ</p>

        <!-- ë¡œê·¸ì¸ëœ ìœ ì €ë§Œ ë³´ì´ê¸° -->
        {% if request.user.is_authenticated %}
          <!-- ë¦¬ë·°ì“°ê¸° ë²„íŠ¼ -->
          <div class="review_create">
            <a href="{% url 'reviews:create' restaurant.pk %}">
              <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="ë¦¬ë·° ì•„ì´ì½˜">
              <span class="review_creation">ë¦¬ë·°ì‘ì„±</span>
            </a>
          </div>
          <p class="division">â”ƒ</p>

          <!-- ë¶ë§ˆí¬ -->
          <div class="bookmark">
            {% if request.user in restaurant.like_users.all %}
              <i id="like-btn" data-restaurant-id="{{ restaurant.pk }}" class="bi bi-star-fill"></i>
            {% else %}
              <i id="like-btn" data-restaurant-id="{{ restaurant.pk }}" class="bi bi-star"></i>
            {% endif %}
            <span class="like_count">{{ restaurant.like_users.count }}</span>
          </div>
          <p class="division">â”ƒ</p>

          <!-- ê°€ê²Œì •ë³´ìˆ˜ì • -->
          <div class="correction">
            {% if request.user.pk == restaurant.user.pk %}
              <img src="https://cdn-icons-png.flaticon.com/512/5258/5258991.png" alt="ì •ë³´ ìˆ˜ì • ì•„ì´ì½˜">
              <a type="submit" onclick="location.href='{% url 'restaurants:update' restaurant.pk %}' ">ì •ë³´ìˆ˜ì •</a>
            {% endif %}
          </div>

          <!-- ë¡œê·¸ì¸ ì•ˆí–ˆì„ ë•Œ -->
        {% else %}
          <div class="bookmark">
            <span id="like-count">{{ restaurant.like_users.count }}</span>
            {% if request.user in restaurant.like_users.all %}
              <i class="bi bi-star-fill" disabled="disabled"></i>
            {% else %}
              <i class="bi bi-star" disabled="disabled"></i>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
    <hr class="separator">
    <!-- ì§€ë„ -->
    <div class="row">
      <div class="col-7">
        <!-- ìŒì‹ì  ì •ë³´í…Œì´ë¸” -->
        <table>
          <tr>
            <th>ì£¼ì†Œ</th>
            <td>{{ restaurant.address }}</td>
          </tr>
          <tr>
            <th>ì „í™”ë²ˆí˜¸</th>
            <td>{{ restaurant.ì „í™”ë²ˆí˜¸.as_national }}</td>
          </tr>
          <tr>
            <th>ì˜ì—…ì‹œê°„</th>
            <td>{{ restaurant.Opening_hours }}</td>
          </tr>
          <tr>
            <th>ê°€ê²©ëŒ€</th>
            <td>{{ restaurant.price_avg }}</td>
          </tr>
          <tr>
            <th>ì£¼ì°¨</th>
            <td>{{ restaurant.parking }}</td>
          </tr>
          <tr>
            <th>íœ´ì¼</th>
            <td>{{ restaurant.day_off }}</td>
          </tr>
          <tr>
            <th>ì¹´í…Œê³ ë¦¬</th>
            <td>{{ restaurant.category }}</td>
          </tr>
          <tr>
            <th>ë©”ë‰´</th>
            <td>
              <div class="d-flex justify-content-between">
                <div class="">
                  {% for restaurant_menu_left_ in restaurant_menu_left %}
                    <p>{{ restaurant_menu_left_ }}</p>
                  {% endfor %}
                </div>
                <div class="">
                  {% for restaurant_menu_right_ in restaurant_menu_right %}
                    <p>{{ restaurant_menu_right_ }}</p>
                  {% endfor %}
                </div>
              </div>
            </td>
          </tr>
        </table>
      </div>
      <div class="col-5 p-0">
        <div id="map" style="height:300px;"></div>
      </div>
    </div>
  </div>

  <!-- ë©”ë‰´ì‚¬ì§„ -->
  <div class="slide-wrapper">
    <ul class="slides">
      {% for img in restaurant.restaurant.all %}
        <li><img src="{{ img.image.url }}" alt="" class="slide-img"></li>
      {% endfor %}
    </ul>
  </div>
  <!-- ë©”ë‰´ ì»¨íŠ¸ë¡¤ëŸ¬ -->
  <p class="controls">
    <span class="prev"><img src="https://cdn-icons-png.flaticon.com/512/151/151846.png" alt="ì´ì „"></span>
    <span class="next"><img src="https://cdn-icons-png.flaticon.com/512/151/151858.png" alt="ë‹¤ìŒ"></span>
  </p>
  <hr class="separator">
  <!-- ë¦¬ë·°ì°½ -->
  <!-- ê°œì¸ ë¦¬ë·° -->
  <div class="row justify-content-between p-3" style="background-color:lightgrey;">
    {% for review in question_list %}
      <div>
        <hr>
        <!-- ë¦¬ë·° ìƒë‹¨ -->
        <div class="d-flex justify-content-between p-1 h-auto">
          <!-- í”„ë¡œí•„/ë§›ìˆë‹¤ -->
          <div class="d-flex">
            <div class="rounded-pill" style="background-color:yellow">
              {% if review.user.image %}
                <img src="{{ review.user.image.url }}" alt="" style="width: 50px; height: 50px; border-radius: 500px">
              {% else %}
                <img src="https://www.dummyimage.com/600x400/000/fff" alt="" style="width: 50px; height: 50px; border-radius: 500px">
              {% endif %}
            </div>
            <div class="">{{ review.user.username }}</div>
            <div class="">
              <!-- ì•„ë˜ ì´ëª¨í‹°ì½˜ì„ ì±„ì›Œì£¼ì„¸ìš”~ -->
              {% if review.grade == 5 %}
                <div>ğŸ˜‹<span>ë§›ìˆì–´ìš”</span></div>
              {% elif review.grade == 3 %}
                <div>ğŸ™‚<span>ê´œì°®ì•„ìš”</span></div>
              {% elif review.grade == 1 %}
                <div>ğŸ˜–<span>ë³„ë£¨ì—ìš”</span></div>
              {% endif %}
            </div>
          </div>

          <!-- ì‹œê°„ -->
          <div>
            {% if review.created_string == False %}
              <td>{{ review.created_string|date:'mì›” dì¼' }}</td>
            {% else %}
              <td>{{ review.created_string }}</td>
            {% endif %}
          </div>
        </div>

        <!-- ë¦¬ë·°ë‚´ìš© -->
        <div class="review-contents">
          <div class="review-content">{{ review.content }}</div>
          <div class="d-flex">
            {% for review_img in review.image.all %}
              <img src="{{ review_img.image.url }}" style="width: 150px; height: 150px; border-radius: 25px;">
              {%endfor%}
            </div>
          </div>
          <div class="text-end">
            {% if review.user.pk == request.user.pk %}
              <a href="{% url 'reviews:update' review.pk restaurant.pk %}" class="link-secondary">ìˆ˜ì •</a>
              <a href="{% url 'reviews:delete' review.pk restaurant.pk %}" class="link-danger">ì‚­ì œ</a>
            {% endif %}
          </div>
          <!-- ë¦¬ë·°ì— ëŒ“ê¸€ ë‹¬ê¸° -->
          <div class="rounded-5" style="background:white">
            <button id="review-comment" type="button" class="btn btn-primary" data-review-id="{{ review.pk }}">ëŒ“ê¸€ë‹¬ê¸°</button>
            <div id="write-comment{{ review.pk }}" class="hidden">
              <form id="commentForm" method="POST" data-review-id="{{ review.pk }}">
                {% csrf_token %}
                {% bootstrap_form comment_form %}
                <input type="submit" class='btn btn-dark' value='ë‹µê¸€'>
              </form>
            </div>
            <div id="comment-create{{review.pk}}">
              <div class="text-primary text-opacity-25">
                .
              </div>
            </div>
            {% for comment in review.comment_set.all %}
              <div>
                {% if comment.user.image %}
                  <img src="{{ comment.user.image.url }}" alt="" style="width: 50px; height: 50px; border-radius: 500px">
                {% else %}
                  <img src="https://www.dummyimage.com/600x400/000/fff" alt="" style="width: 50px; height: 50px; border-radius: 500px">
                {% endif %}
                <span>{{comment.user}}</span>
                <span>{{comment.content}}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        {% empty %}
        <p class="text-center">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ë·°ë¥¼ ë‚¨ê²¨
          <b>{{ restaurant.restaurant_name }}</b>ì˜ ì²«ë²ˆì§¸ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”.
        </p>
      {% endfor %}
    </div>
  </div>

  <!-- í˜ì´ì§•ì²˜ë¦¬ ì‹œì‘ -->
  <ul class="pagination justify-content-center">
    <!-- ì´ì „í˜ì´ì§€ -->
    {% if question_list.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ question_list.previous_page_number }}">ì´ì „</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <a class="page-link" tabindex="-1" aria-disabled="true" href="#">ì´ì „</a>
      </li>
    {% endif %}
    <!-- í˜ì´ì§€ë¦¬ìŠ¤íŠ¸ -->
    {% for page_number in question_list.paginator.page_range %}
      {% if page_number == question_list.number %}
        <li class="page-item active" aria-current="page">
          <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
        </li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
        </li>
      {% endif %}
    {% endfor %}
    <!-- ë‹¤ìŒí˜ì´ì§€ -->
    {% if question_list.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ question_list.next_page_number }}">ë‹¤ìŒ</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <a class="page-link" tabindex="-1" aria-disabled="true" href="#">ë‹¤ìŒ</a>
      </li>
    {% endif %}
  </ul>
{% endblock content %}

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
{% block js %}
  <script src="{% static 'restaurants/js/detail.js' %}"></script>

  <!-- ì§€ë„ -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ JSMAPKEY }}&libraries=services"></script>
  <script>
    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
      mapOption = {
        center: new kakao
          .maps
          .LatLng(33.450701, 126.570667), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
        level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
      };
    // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var map = new kakao
      .maps
      .Map(mapContainer, mapOption);
    // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var geocoder = new kakao
      .maps
      .services
      .Geocoder();
    var address = '{{ restaurant.address }}';
    // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
    geocoder.addressSearch(address, function (result, status) {
      // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
      if (status === kakao.maps.services.Status.OK) {
        var coords = new kakao
          .maps
          .LatLng(result[0].y, result[0].x);
        // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
        var marker = new kakao
          .maps
          .Marker({map: map, position: coords});
        // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
        var infowindow = new kakao
          .maps
          .InfoWindow({content: `<div style="width:150px;text-align:center;padding:6px 0;">{{ restaurant.restaurant_name }}</div>`});
        infowindow.open(map, marker);
        // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
        map.setCenter(coords);
      }
    });
  </script>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const reviewComments = document.querySelectorAll(`#review-comment`)
    for (const reviewComment of reviewComments) {
      reviewComment.addEventListener("click", function (event) {
        const reviewId = event.target.dataset.reviewId;
        event.preventDefault()
        const writeComment = document.querySelector(`#write-comment${reviewId}`)
        writeComment
          .classList
          .toggle("hidden")
      })
    }
    const commentForms = document.querySelectorAll("#commentForm")
    for (const commentForm of commentForms) {
      commentForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const csrftoken = document
          .querySelector('[name=csrfmiddlewaretoken]')
          .value;
        const reviewId = event
          .target
          .dataset
          .reviewId
          axios({
            method: "post",
            url: `/reviews/${reviewId}/comments/`,
            headers: {
              'X-CSRFToken': csrftoken
            },
            data: new FormData(commentForm)
          })
          .then((response) => {
            const comments = document.querySelector(`#comment-create${reviewId}`)
            comments.insertAdjacentHTML('beforeend', `
          <div>
            {% if comment.user.image %}
              <img src="{{ comment.user.image.url }}" alt="" style="width: 50px; height: 50px; border-radius: 500px">
            {% else %}
              <img src="https://www.dummyimage.com/600x400/000/fff" alt="" style="width: 50px; height: 50px; border-radius: 500px">
            {% endif %}
            <span>${response.data.comment_review_content}</span>
          </div>`)
            commentForm.reset()
          })
      })
    }
  </script>

{% endblock js %}